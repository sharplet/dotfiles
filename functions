#!/bin/sh

# present a project selector and change to the selected directory
go() {
  base=${1:-$PROJ_ROOT}
  if [ -z "$base" ]; then
    echo >&2 "error: PROJ_ROOT must be set or a base directory passed as the first argument"
    return 1
  fi

  findopts=(-type d -maxdepth 4 -mindepth 2)
  excludes='.cocoapods|.vim/bundle'

  dir=$(
    find -H $base ${findopts[*]} -path '*/.git' 2>/dev/null \
      | sed 's,/.git$,,' \
      | grep -vE "$excludes" \
      | xargs -I{} stat -f '%m %N' '{}' | sort -nr \
      | sed -E 's,^[0-9]+ ,,' \
      | sed -E "s,^$base/(src/)?,," \
      | pick
  )

  # after selecting a project, expand it back out to its full path and jump to it
  if [ -n "$dir" ]; then
    dest=$base/$dir
    if [ ! -d "$dest" ]; then
      dest=$base/src/$dir
    fi
    touch "$dest" && cd "$dest"
  fi
}

exit_status_colors() {
  # shellcheck disable=SC2181
  exit_status=$?

  cyan=\\e\[36\;1m
  red=\\e\[31\;1m
  reset=\\e\[0m

  if [ $exit_status != 0 ]; then
    echo "$red$*$reset"
  else
    echo "$cyan$*$reset"
  fi
}
